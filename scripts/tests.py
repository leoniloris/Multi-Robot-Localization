import path_following
import numpy as np
import rospy
import sys
import os
import re

from geometry_msgs.msg import Twist
from nav_msgs.msg import Odometry
from sensor_msgs.msg import LaserScan


def follow_path_from_file():
    def get_occupancy_grid():
        occupancy_grid_file = re.findall(r'/occupancy_grid/(.*)"', open(f'{os.environ["HOME"]}/catkin_ws/src/multi_robot_localization/src/occupancy_grid.cpp', mode='r').read())[0]
        return np.loadtxt(f'{os.environ["HOME"]}/catkin_ws/src/multi_robot_localization/occupancy_grid/{occupancy_grid_file}', delimiter=",")

    def get_trajectory_from_file(robot_suffix):
        with open(f'{os.environ["HOME"]}/catkin_ws/src/multi_robot_localization/trajectories/a_star_{robot_suffix}_obstacles.txt') as f:
            return [tuple(map(float, i.split(','))) for i in f]

    robot_suffix = sys.argv[2]
    rospy.init_node(f'path_following_{robot_suffix}')
    # trajectory = get_trajectory_from_file(robot_suffix)
    # path_landmarks = [path_following.Landmark(*l) for l in trajectory]

    path_landmarks = [path_following.Landmark(x=102.0, y=111.0, checked=False), path_following.Landmark(x=101.5, y=110.5, checked=False), path_following.Landmark(x=101.0, y=110.0, checked=False), path_following.Landmark(x=100.0, y=109.0, checked=False), path_following.Landmark(x=98.5, y=107.5, checked=False), path_following.Landmark(x=97.5, y=106.5, checked=False), path_following.Landmark(x=97.0, y=106.0, checked=False), path_following.Landmark(x=96.0, y=105.0, checked=False), path_following.Landmark(x=95.5, y=104.5, checked=False), path_following.Landmark(x=95.0, y=104.0, checked=False), path_following.Landmark(x=94.0, y=103.0, checked=False), path_following.Landmark(x=93.5, y=102.5, checked=False), path_following.Landmark(x=93.5, y=102.5, checked=False), path_following.Landmark(x=93.5, y=102.5, checked=False), path_following.Landmark(x=93.5, y=102.5, checked=False), path_following.Landmark(x=93.5, y=102.5, checked=False), path_following.Landmark(x=93.5, y=102.5, checked=False), path_following.Landmark(x=93.5, y=102.5, checked=False), path_following.Landmark(x=92.5, y=101.5, checked=False), path_following.Landmark(x=91.5, y=100.5, checked=False), path_following.Landmark(x=90.5, y=99.5, checked=False), path_following.Landmark(x=89.5, y=98.5, checked=False), path_following.Landmark(x=88.5, y=97.5, checked=False), path_following.Landmark(x=87.5, y=96.5, checked=False), path_following.Landmark(x=86.5, y=95.5, checked=False), path_following.Landmark(x=85.5, y=94.5, checked=False), path_following.Landmark(x=84.5, y=93.5, checked=False), path_following.Landmark(x=83.5, y=92.5, checked=False), path_following.Landmark(x=82.5, y=91.5, checked=False), path_following.Landmark(x=81.5, y=90.5, checked=False), path_following.Landmark(x=80.5, y=89.5, checked=False), path_following.Landmark(x=79.5, y=88.5, checked=False), path_following.Landmark(x=79.0, y=87.5, checked=False), path_following.Landmark(x=78.625, y=86.5, checked=False), path_following.Landmark(x=78.5, y=85.66666666666667, checked=False), path_following.Landmark(x=78.625, y=85.0, checked=False), path_following.Landmark(x=79.0, y=84.75, checked=False), path_following.Landmark(x=79.625, y=84.375, checked=False), path_following.Landmark(x=80.5, y=84.3, checked=False), path_following.Landmark(x=81.5, y=84.25, checked=False), path_following.Landmark(x=82.5, y=84.21428571428571, checked=False), path_following.Landmark(x=83.5, y=84.33333333333333, checked=False), path_following.Landmark(x=84.5, y=84.16666666666667, checked=False), path_following.Landmark(x=85.5, y=84.05555555555556, checked=False), path_following.Landmark(x=86.5, y=84.0, checked=False), path_following.Landmark(x=87.5, y=84.0, checked=False), path_following.Landmark(x=88.5, y=84.0, checked=False), path_following.Landmark(x=89.5, y=84.0, checked=False), path_following.Landmark(x=90.5, y=84.0, checked=False), path_following.Landmark(x=91.5, y=84.0, checked=False), path_following.Landmark(x=92.5, y=84.0, checked=False), path_following.Landmark(x=93.5, y=84.0, checked=False), path_following.Landmark(x=94.5, y=84.0, checked=False), path_following.Landmark(x=95.5, y=84.0, checked=False), path_following.Landmark(x=96.5, y=84.0, checked=False), path_following.Landmark(x=97.5, y=84.0, checked=False), path_following.Landmark(x=98.5, y=84.0, checked=False), path_following.Landmark(x=99.5, y=84.0, checked=False), path_following.Landmark(x=100.5, y=84.0, checked=False), path_following.Landmark(x=101.5, y=84.0, checked=False), path_following.Landmark(x=102.5, y=84.0, checked=False), path_following.Landmark(x=103.5, y=84.0, checked=False), path_following.Landmark(x=104.5, y=83.94444444444444, checked=False), path_following.Landmark(x=105.5, y=83.83333333333333, checked=False), path_following.Landmark(x=106.5, y=83.66666666666667, checked=False), path_following.Landmark(x=107.5, y=83.44444444444444, checked=False), path_following.Landmark(x=108.5, y=83.57142857142857, checked=False), path_following.Landmark(x=109.5, y=83.5, checked=False), path_following.Landmark(x=110.5, y=83.4, checked=False), path_following.Landmark(x=111.33333333333333, y=83.25, checked=False), path_following.Landmark(x=112.0, y=82.75, checked=False), path_following.Landmark(x=112.25, y=82.33333333333333, checked=False), path_following.Landmark(x=112.625, y=81.5, checked=False), path_following.Landmark(x=112.7, y=80.5, checked=False), path_following.Landmark(x=112.8, y=79.5, checked=False), path_following.Landmark(x=112.7, y=78.5, checked=False), path_following.Landmark(x=112.4, y=77.5, checked=False), path_following.Landmark(x=112.25, y=76.5, checked=False), path_following.Landmark(x=111.75, y=75.5, checked=False), path_following.Landmark(x=111.33333333333333, y=74.5, checked=False), path_following.Landmark(x=110.5, y=73.5, checked=False), path_following.Landmark(x=109.5, y=72.5, checked=False), path_following.Landmark(x=108.5, y=71.5, checked=False), path_following.Landmark(x=107.5, y=70.5, checked=False), path_following.Landmark(x=106.5, y=69.5, checked=False), path_following.Landmark(x=105.5, y=68.5, checked=False), path_following.Landmark(x=104.5, y=67.5, checked=False), path_following.Landmark(x=103.5, y=66.5, checked=False), path_following.Landmark(x=102.5, y=65.5, checked=False), path_following.Landmark(x=101.5, y=64.5, checked=False), path_following.Landmark(x=100.5, y=63.5, checked=False), path_following.Landmark(x=99.5, y=62.5, checked=False), path_following.Landmark(x=98.5, y=61.5, checked=False), path_following.Landmark(x=97.5, y=60.5, checked=False), path_following.Landmark(x=96.5, y=59.5, checked=False), path_following.Landmark(x=95.5, y=58.5, checked=False), path_following.Landmark(x=94.5, y=57.5, checked=False), path_following.Landmark(x=93.5, y=56.5, checked=False), path_following.Landmark(x=92.5, y=55.666666666666664, checked=False), path_following.Landmark(x=91.5, y=55.25, checked=False), path_following.Landmark(x=90.5, y=54.875, checked=False), path_following.Landmark(x=89.5, y=54.9, checked=False), path_following.Landmark(x=88.5, y=54.7, checked=False), path_following.Landmark(x=87.5, y=55.07142857142857, checked=False), path_following.Landmark(x=86.5, y=55.1875, checked=False), path_following.Landmark(x=85.5, y=55.333333333333336, checked=False), path_following.Landmark(x=84.5, y=55.333333333333336, checked=False), path_following.Landmark(x=83.5, y=55.388888888888886, checked=False), path_following.Landmark(x=82.5, y=55.55555555555556, checked=False), path_following.Landmark(x=81.5, y=55.75, checked=False), path_following.Landmark(x=80.5, y=56.0, checked=False), path_following.Landmark(x=79.5, y=56.25, checked=False), path_following.Landmark(x=78.5, y=56.42857142857143, checked=False), path_following.Landmark(x=77.5, y=56.714285714285715, checked=False), path_following.Landmark(x=76.5, y=57.07142857142857, checked=False), path_following.Landmark(x=75.5, y=57.07142857142857, checked=False), path_following.Landmark(x=74.5, y=57.23076923076923, checked=False), path_following.Landmark(x=73.5, y=57.333333333333336, checked=False), path_following.Landmark(x=72.5, y=57.45454545454545, checked=False), path_following.Landmark(x=72.0, y=57.45454545454545, checked=False), path_following.Landmark(x=72.0, y=57.6, checked=False), path_following.Landmark(x=71.5, y=57.77777777777778, checked=False)]\
                        if str(robot_suffix) == '1' else [path_following.Landmark(x=106.0, y=111.0, checked=False),  path_following.Landmark(x=105.5, y=110.5, checked=False),  path_following.Landmark(x=105.0, y=110.0, checked=False),  path_following.Landmark(x=104.0, y=109.0, checked=False),  path_following.Landmark(x=102.5, y=107.5, checked=False),  path_following.Landmark(x=101.5, y=106.5, checked=False),  path_following.Landmark(x=101.0, y=106.0, checked=False),  path_following.Landmark(x=100.0, y=105.0, checked=False),  path_following.Landmark(x=99.5, y=104.5, checked=False),  path_following.Landmark(x=99.0, y=104.0, checked=False),  path_following.Landmark(x=98.0, y=103.0, checked=False),  path_following.Landmark(x=97.5, y=102.5, checked=False),  path_following.Landmark(x=97.5, y=102.5, checked=False),  path_following.Landmark(x=97.5, y=102.5, checked=False),  path_following.Landmark(x=97.5, y=102.5, checked=False),  path_following.Landmark(x=97.5, y=102.5, checked=False),  path_following.Landmark(x=97.5, y=102.5, checked=False),  path_following.Landmark(x=97.5, y=102.5, checked=False),  path_following.Landmark(x=96.5, y=101.5, checked=False),  path_following.Landmark(x=95.5, y=100.5, checked=False),  path_following.Landmark(x=94.5, y=99.5, checked=False),  path_following.Landmark(x=93.5, y=98.5, checked=False),  path_following.Landmark(x=92.5, y=97.5, checked=False),  path_following.Landmark(x=91.5, y=96.5, checked=False),  path_following.Landmark(x=90.5, y=95.5, checked=False),  path_following.Landmark(x=89.5, y=94.5, checked=False),  path_following.Landmark(x=88.5, y=93.5, checked=False),  path_following.Landmark(x=87.5, y=92.5, checked=False),  path_following.Landmark(x=86.5, y=91.5, checked=False),  path_following.Landmark(x=85.5, y=90.5, checked=False),  path_following.Landmark(x=84.5, y=89.5, checked=False),  path_following.Landmark(x=83.5, y=88.5, checked=False),  path_following.Landmark(x=82.5, y=87.5, checked=False),  path_following.Landmark(x=82.25, y=86.5, checked=False),  path_following.Landmark(x=82.0, y=85.66666666666667, checked=False),  path_following.Landmark(x=82.0, y=85.0, checked=False),  path_following.Landmark(x=82.25, y=84.75, checked=False),  path_following.Landmark(x=82.75, y=84.375, checked=False),  path_following.Landmark(x=83.5, y=84.3, checked=False),  path_following.Landmark(x=84.5, y=84.25, checked=False),  path_following.Landmark(x=85.5, y=84.21428571428571, checked=False),  path_following.Landmark(x=86.5, y=84.33333333333333, checked=False),  path_following.Landmark(x=87.5, y=84.16666666666667, checked=False),  path_following.Landmark(x=88.5, y=84.05555555555556, checked=False),  path_following.Landmark(x=89.5, y=84.0, checked=False),  path_following.Landmark(x=90.5, y=84.0, checked=False),  path_following.Landmark(x=91.5, y=84.0, checked=False),  path_following.Landmark(x=92.5, y=84.0, checked=False),  path_following.Landmark(x=93.5, y=84.0, checked=False),  path_following.Landmark(x=94.5, y=84.0, checked=False),  path_following.Landmark(x=95.5, y=84.0, checked=False),  path_following.Landmark(x=96.5, y=84.0, checked=False),  path_following.Landmark(x=97.5, y=84.0, checked=False),  path_following.Landmark(x=98.5, y=84.0, checked=False),  path_following.Landmark(x=99.5, y=84.0, checked=False),  path_following.Landmark(x=100.5, y=84.0, checked=False),  path_following.Landmark(x=101.5, y=84.0, checked=False),  path_following.Landmark(x=102.5, y=84.0, checked=False),  path_following.Landmark(x=103.5, y=84.0, checked=False),  path_following.Landmark(x=104.5, y=83.94444444444444, checked=False),  path_following.Landmark(x=105.5, y=83.83333333333333, checked=False),  path_following.Landmark(x=106.5, y=83.66666666666667, checked=False),  path_following.Landmark(x=107.5, y=83.44444444444444, checked=False),  path_following.Landmark(x=108.5, y=83.57142857142857, checked=False),  path_following.Landmark(x=109.5, y=83.5, checked=False),  path_following.Landmark(x=110.5, y=83.4, checked=False),  path_following.Landmark(x=111.33333333333333, y=83.25, checked=False),  path_following.Landmark(x=112.0, y=82.75, checked=False),  path_following.Landmark(x=112.25, y=82.33333333333333, checked=False),  path_following.Landmark(x=112.625, y=81.5, checked=False),  path_following.Landmark(x=112.7, y=80.5, checked=False),  path_following.Landmark(x=112.8, y=79.5, checked=False),  path_following.Landmark(x=112.7, y=78.5, checked=False),  path_following.Landmark(x=112.4, y=77.5, checked=False),  path_following.Landmark(x=112.25, y=76.5, checked=False),  path_following.Landmark(x=111.75, y=75.5, checked=False),  path_following.Landmark(x=111.33333333333333, y=74.5, checked=False),  path_following.Landmark(x=110.5, y=73.5, checked=False),  path_following.Landmark(x=109.5, y=72.5, checked=False),  path_following.Landmark(x=108.5, y=71.5, checked=False),  path_following.Landmark(x=107.5, y=70.5, checked=False),  path_following.Landmark(x=106.5, y=69.5, checked=False),  path_following.Landmark(x=105.5, y=68.5, checked=False),  path_following.Landmark(x=104.5, y=67.5, checked=False),  path_following.Landmark(x=103.5, y=66.5, checked=False),  path_following.Landmark(x=102.5, y=65.5, checked=False),  path_following.Landmark(x=101.5, y=64.5, checked=False),  path_following.Landmark(x=100.5, y=63.5, checked=False),  path_following.Landmark(x=99.5, y=62.5, checked=False),  path_following.Landmark(x=98.5, y=61.5, checked=False),  path_following.Landmark(x=97.5, y=60.5, checked=False),  path_following.Landmark(x=96.5, y=59.5, checked=False),  path_following.Landmark(x=95.5, y=58.5, checked=False),  path_following.Landmark(x=94.5, y=57.5, checked=False),  path_following.Landmark(x=93.5, y=56.5, checked=False),  path_following.Landmark(x=92.5, y=55.666666666666664, checked=False),  path_following.Landmark(x=91.5, y=55.25, checked=False),  path_following.Landmark(x=90.5, y=54.875, checked=False),  path_following.Landmark(x=89.5, y=54.9, checked=False),  path_following.Landmark(x=88.5, y=54.7, checked=False),  path_following.Landmark(x=87.5, y=55.07142857142857, checked=False),  path_following.Landmark(x=86.5, y=55.1875, checked=False),  path_following.Landmark(x=85.5, y=55.333333333333336, checked=False),  path_following.Landmark(x=84.5, y=55.333333333333336, checked=False),  path_following.Landmark(x=83.5, y=55.388888888888886, checked=False),  path_following.Landmark(x=82.5, y=55.55555555555556, checked=False),  path_following.Landmark(x=81.5, y=55.75, checked=False),  path_following.Landmark(x=80.5, y=56.0, checked=False),  path_following.Landmark(x=79.5, y=56.25, checked=False),  path_following.Landmark(x=78.5, y=56.42857142857143, checked=False),  path_following.Landmark(x=77.5, y=56.714285714285715, checked=False),  path_following.Landmark(x=76.5, y=57.07142857142857, checked=False),  path_following.Landmark(x=75.5, y=57.07142857142857, checked=False),  path_following.Landmark(x=74.5, y=57.23076923076923, checked=False),  path_following.Landmark(x=73.5, y=57.333333333333336, checked=False),  path_following.Landmark(x=72.5, y=57.45454545454545, checked=False),  path_following.Landmark(x=72.0, y=57.45454545454545, checked=False),  path_following.Landmark(x=72.0, y=57.6, checked=False),  path_following.Landmark(x=71.5, y=57.77777777777778, checked=False)]
    trajectory = [(l.x,l.y) for l in path_landmarks]

    import matplotlib.pyplot as plt
    import seaborn as sns
    fig = plt.figure()
    fig.suptitle(f'{robot_suffix}', fontsize=20)
    sns.heatmap(get_occupancy_grid())
    plt.scatter(list(zip(*trajectory))[1], list(zip(*trajectory))[0])
    plt.pause(5)


    path_follower = path_following.PathFollower(path_landmarks)
    actuator = rospy.Publisher('/ugv' + str(robot_suffix) + '/cmd_vel', Twist, queue_size=10)
    sub = rospy.Subscriber('/ugv' + str(robot_suffix) + '/odom', Odometry, path_follower.clbk_odometry)
    sub = rospy.Subscriber('/ugv' + str(robot_suffix) + '/scan', LaserScan, path_follower.clbk_laser)

    rate = rospy.Rate(10)
    while not rospy.is_shutdown():
        actuator.publish(path_follower.control_msg)
        rate.sleep()


def follow_a_star_path():
    def get_occupancy_grid():
        occupancy_grid_file = re.findall(r'/occupancy_grid/(.*)"', open(f'{os.environ["HOME"]}/catkin_ws/src/multi_robot_localization/src/occupancy_grid.cpp', mode='r').read())[0]
        return np.loadtxt(f'{os.environ["HOME"]}/catkin_ws/src/multi_robot_localization/occupancy_grid/{occupancy_grid_file}', delimiter=",")
    robot_suffix, x1, y1, x2, y2 = sys.argv[2], int(sys.argv[3]), int(sys.argv[4]), int(sys.argv[5]), int(sys.argv[6])
    rospy.init_node(f'path_following_{robot_suffix}')
    print(f'start={(x1, y1)}, end={(x2, y2)}')
    occupancy_grid = get_occupancy_grid()
    path_landmarks = [path_following.Landmark(*l) for l in path_planner.a_star(occupancy_grid, (x1, y1), (x2, y2))]

    path_follower = path_following.PathFollower(path_landmarks)
    actuator = rospy.Publisher('/ugv' + str(robot_suffix) + '/cmd_vel', Twist, queue_size=10)
    sub = rospy.Subscriber('/ugv' + str(robot_suffix) + '/odom', Odometry, path_follower.clbk_odometry)

    rate = rospy.Rate(10)
    while not rospy.is_shutdown():
        actuator.publish(path_follower.control_msg)
        rate.sleep()


if __name__ == '__main__':
    test_to_run = sys.argv[1]
    # exec(test_to_run)
    follow_path_from_file()
